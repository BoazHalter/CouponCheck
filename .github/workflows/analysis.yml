name: Download All Coupon Results Ever

on:
  workflow_dispatch:    # You trigger it manually from the Actions tab

permissions:
  contents: read
  actions: read         # Needed to list and download artifacts

jobs:
  download-all-artifacts:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository (optional, only if you need code)
        uses: actions/checkout@v4

      - name: Download EVERY coupon-results artifact from the repo
        run: |
          mkdir -p all-artifacts
          cd all-artifacts

          echo "Starting download of all existing artifacts..."

          page=1
          while true; do
            echo "Fetching page $page of artifacts..."
            artifacts=$(gh api \
              "/repos/${{ github.repository }}/actions/artifacts?per_page=100&page=$page" \
              --paginate \
              -q '.artifacts[] | select(.expired == false) | .id')

            if [[ -z "$artifacts" ]]; then
              echo "No more artifacts to fetch."
              break
            fi

            echo "$artifacts" | while read -r id; do
              if [[ -n "$id" ]]; then
                echo "Downloading artifact ID $id ..."
                gh api \
                  --silent \
                  "/repos/${{ github.repository }}/actions/artifacts/$id/zip" \
                  -o "coupon-results-artifact-$id.zip"
              fi
            done

            ((page++))
          done

          total=$(ls -1 coupon-results-artifact-*.zip 2>/dev/null | wc -l)
          echo "Successfully downloaded $total artifacts!"
          ls -lh coupon-results-artifact-*.zip | head -15

      - name: Upload all downloaded artifacts as one big bundle
        uses: actions/upload-artifact@v4
        with:
          name: all-coupon-results-ever-${{ github.run_number }}-${{ github.run_attempt }}
          path: all-artifacts/coupon-results-artifact-*.zip
          retention-days: 30
          if-no-files-found: error
