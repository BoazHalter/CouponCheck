name: Download all existing artifacts

on:
  workflow_dispatch:   # or schedule, push, etc.

permissions:
  contents: read
  actions: read      # required to list artifacts

jobs:
  download-all-artifacts:
    runs-on: ubuntu-latest
    steps:
      - name: Download ALL artifacts from the repository
        env:
          GH_TOKEN: ${{ github.token }}   # default GITHUB_TOKEN has actions:read
        run: |
          mkdir -p all-artifacts
          cd all-artifacts

          # Pagination handling (GitHub returns max 100 per page)
          page=1
          while true; do
            response=$(gh api \
              -H "Accept: application/vnd.github+json" \
              "/repos/${{ github.repository }}/actions/artifacts?per_page=100&page=$page" \
              --jq '.artifacts')

            # If no more artifacts, break
            if [[ "$response" == "[]" || -z "$response" ]]; then
              echo "No more artifacts."
              break
            fi

            echo "$response" | jq -r '.[] | "\(.id) \(.name) \(.workflow_run.id // "unknown") \(.created_at)"'

            # Download each artifact in the current page
            echo "$response" | jq -r '.[].id' | while read artifact_id; do
              if [[ -n "$artifact_id" && "$artifact_id" != "null" ]]; then
                echo "Downloading artifact ID $artifact_id ..."
                gh api \
                  -H "Accept: application/vnd.github+json" \
                  "/repos/${{ github.repository }}/actions/artifacts/$artifact_id/zip" \
                  --silent --output "artifact-$artifact_id.zip"
              fi
            done

            ((page++))
          done

          echo "All artifacts downloaded to $(pwd)"
          ls -lh

      # Optional: unzip everything (be careful with name clashes)
      - name: Extract all artifacts
        if: false   # enable if you really want to extract everything
        run: |
          for f in all-artifacts/*.zip; do
            dir=$(basename "$f" .zip)
            mkdir -p "extracted/$dir"
            unzip -o "$f" -d "extracted/$dir"
          done
